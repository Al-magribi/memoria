import{j as e,s,u as a,t as i,v as t,w as n,x as r,z as l,A as d,y as c}from"./index-DzKEBV7U.js";import{b as o,h}from"./vendor-aDN--sgP.js";import{p as m,q as u,r as g,s as f,o as p,t as x,u as j,a as v,I as N,v as y,w,x as S}from"./Layout-D5fUhYb-.js";import"./iconBase-GrFdhYN9.js";const C=({chats:s=[],filteredFriends:a=[],searchQuery:i="",onSearchChange:t,onSearchFocus:n,onSearchBlur:r,onFriendSelect:l,onChatSelect:d,selectedChat:c,showSearchResults:o,onlineUsers:h=new Set})=>e.jsxs("div",{className:"chat-list",children:[e.jsxs("div",{className:"chat-list-header",children:[e.jsx("h2",{children:"Messages"}),e.jsx("div",{className:"search-box",children:e.jsx("input",{type:"text",placeholder:"Search friends...",value:i,onChange:t,onFocus:n,onBlur:r})})]}),e.jsx("div",{className:"chat-items",children:o&&i?a.length>0?a.map(s=>e.jsxs("div",{className:"chat-item search-result",onClick:()=>l(s),children:[e.jsxs("div",{className:"chat-avatar",children:[e.jsx("img",{src:s.profilePicture||"/profiles/user.jpg",alt:s.username}),h.has(s.id)&&e.jsx("div",{className:"online-indicator"})]}),e.jsxs("div",{className:"chat-info",children:[e.jsx("div",{className:"chat-header",children:e.jsx("h4",{children:s.username})}),e.jsx("div",{className:"chat-preview",children:e.jsxs("p",{children:[s.firstName," ",s.lastName]})})]})]},s.id)):e.jsx("div",{className:"no-search-results",children:e.jsxs("p",{children:['No friends found matching "',i,'"']})}):s.map(s=>e.jsxs("div",{className:"chat-item "+((null==c?void 0:c.id)===s.id?"active":""),onClick:()=>d(s),children:[e.jsxs("div",{className:"chat-avatar",children:[e.jsx("img",{src:s.avatar,alt:s.name}),h.has(s.participantId)&&e.jsx("div",{className:"online-indicator"})]}),e.jsxs("div",{className:"chat-info",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx("h4",{children:s.name}),e.jsx("span",{className:"chat-time",children:s.time})]}),e.jsxs("div",{className:"chat-preview",children:[e.jsx("p",{style:{fontStyle:"italic"},children:"image"===s.lastMessageType?"image":"video"===s.lastMessageType?"video":s.lastMessage}),s.unread>0&&e.jsx("div",{className:"unread-badge",children:s.unread})]})]})]},s.id))})]}),I=({user:s,isMobile:a,onBack:i,online:t})=>e.jsxs("div",{className:"chat-header",children:[a&&e.jsx("button",{className:"back-btn",onClick:i,children:e.jsx(m,{})}),e.jsxs("div",{className:"chat-user-info",children:[e.jsxs("div",{className:"chat-avatar",children:[e.jsx("img",{src:s.avatar||s.profilePicture||"/profiles/user.jpg",alt:s.name||s.username}),t&&e.jsx("div",{className:"online-indicator"})]}),e.jsxs("div",{children:[e.jsx("h3",{children:s.name||s.username}),e.jsx("span",{className:"status",children:t?"Online":"Offline"})]})]}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("button",{className:"action-btn",children:e.jsx(u,{})}),e.jsx("button",{className:"action-btn",children:e.jsx(g,{})})]})]}),T=({messages:s=[],hasMessages:a,typingUsers:i,user:t,messagesEndRef:n})=>e.jsx("div",{className:"messages-container",children:e.jsxs("div",{className:"messages",children:[a?s.map(s=>e.jsx("div",{className:"message "+(s.isOwn?"own":"other"),children:e.jsxs("div",{className:"message-content",children:["image"===s.messageType&&s.fileUrl?e.jsx("img",{src:s.fileUrl,alt:s.message||"image",className:"chat-media-message"}):"video"===s.messageType&&s.fileUrl?e.jsx("video",{src:s.fileUrl,controls:!0,className:"chat-media-message"}):e.jsx("p",{children:s.message}),e.jsx("span",{className:"message-time",children:s.time})]})},s.id)):e.jsx("div",{className:"start-chat-message",children:e.jsxs("div",{className:"start-chat-content",children:[e.jsx(f,{}),e.jsx("h3",{children:"Start a conversation"}),e.jsxs("p",{children:["Send a message to begin chatting with"," ",t.name||t.username]})]})}),i&&i.size>0&&e.jsx("div",{className:"message other typing-message",children:e.jsx("div",{className:"message-content",children:e.jsx("p",{className:"typing-indicator",children:"is typing..."})})}),e.jsx("div",{ref:n})]})}),b=({messageInput:s,onInputChange:a,onKeyPress:i,onSend:t,disabled:n,onAttach:r,attachedFiles:l=[],onRemoveFile:d,isUploading:c=!1})=>{const h=o.useRef(null),m=e=>{if(0===e)return"0 Bytes";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]};return e.jsxs("div",{className:"message-input-container",children:[l.length>0&&e.jsx("div",{className:"file-preview-container",children:e.jsx("div",{className:"file-preview-list",children:l.map(s=>e.jsxs("div",{className:"file-preview-item",children:[e.jsxs("div",{className:"file-preview-content",children:[s.type.startsWith("image/")?e.jsx("img",{src:s.preview,alt:s.name,className:"file-preview-image"}):e.jsx("div",{className:"file-preview-icon",children:s.icon}),e.jsxs("div",{className:"file-preview-info",children:[e.jsx("div",{className:"file-name",children:s.name}),e.jsx("div",{className:"file-size",children:m(s.size)})]})]}),e.jsx("button",{className:"remove-file-btn",onClick:()=>d(s.id),disabled:c,children:e.jsx(p,{})})]},s.id))})}),e.jsxs("div",{className:"message-input-wrapper",children:[e.jsx("button",{className:"attach-btn",onClick:()=>h.current.click(),disabled:n||c,children:e.jsx(x,{})}),e.jsx("input",{type:"file",multiple:!0,ref:h,style:{display:"none"},onChange:r,disabled:n||c}),e.jsx("textarea",{className:"message-textarea",placeholder:c?"Uploading files...":"Type a message...",value:s,onChange:a,onKeyDown:i,rows:1,disabled:n||c}),e.jsx("button",{className:"send-btn",onClick:t,disabled:!s.trim()&&0===l.length||n||c,children:e.jsx(j,{})})]})]})},F=()=>{const[m,u]=o.useState(null),[f,p]=o.useState(""),[x,j]=o.useState(window.innerWidth<=768),[F]=h(),[M,U]=o.useState(new Set),[E,k]=o.useState(""),[B,R]=o.useState(!1),[W,z]=o.useState(null),[L,P]=o.useState([]),[A,K]=o.useState(!1),{socket:O,isConnected:D,onlineUsers:_}=s(),{user:Q}=a(e=>e.user),$=o.useRef(null),J=o.useRef(null),{data:q=[],refetch:G}=i(),{data:V=[],refetch:H}=t(null==m?void 0:m.id,{skip:!(null==m?void 0:m.id)}),{data:X}=n(),[Y,{error:Z}]=r(),[ee]=l(),[se]=d();o.useEffect(()=>{const e=()=>j(window.innerWidth<=768);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),o.useEffect(()=>{const e=F.get("friendId");if(e){const s=q.find(s=>String(s.participantId)===String(e));if(s)u(s);else{const s=((null==X?void 0:X.friends)||[]).find(s=>String(s.id)===String(e));s&&z(s)}}},[F,q,X,Y]),o.useEffect(()=>{if(O)return(null==m?void 0:m.id)&&(O.emit("joinChat",m.id),ee(m.id),H()),O.on("newMessage",e=>{e.chatId===(null==m?void 0:m.id)&&H(),G()}),O.on("error",e=>{c.error("Socket error: "+e.message)}),O.on("chatUpdated",e=>{G()}),O.on("userTyping",e=>{e.chatId===(null==m?void 0:m.id)&&U(s=>new Set([...s,e.userId]))}),O.on("userStopTyping",e=>{e.chatId===(null==m?void 0:m.id)&&U(s=>{const a=new Set(s);return a.delete(e.userId),a})}),()=>{(null==m?void 0:m.id)&&O.emit("leaveChat",m.id),O.off("newMessage"),O.off("chatUpdated"),O.off("userTyping"),O.off("userStopTyping")}},[O,m,H,G,ee]),o.useEffect(()=>{var e;null==(e=$.current)||e.scrollIntoView({behavior:"smooth"})},[V,M]);const ae=((null==X?void 0:X.friends)||[]).filter(e=>e.username.toLowerCase().includes(E.toLowerCase())||e.firstName.toLowerCase().includes(E.toLowerCase())||e.lastName.toLowerCase().includes(E.toLowerCase())),ie=async()=>{if((f.trim()||0!==L.length)&&O&&D&&Q)if(A)c.info("Please wait, files are being uploaded...");else{K(!0);try{let s=[];if(L.length>0){const e=L.map(async e=>{try{return{fileUrl:(await se(e.file).unwrap()).fileUrl,fileName:e.name,fileType:e.type}}catch(s){throw console.error("Error uploading file:",s),new Error(`Failed to upload ${e.name}`)}});s=await Promise.all(e)}if(m){console.log("Sending message to existing chat:",m.id),f.trim()&&O.emit("sendMessage",{chatId:m.id,content:f.trim(),messageType:"text"});for(const e of s)O.emit("sendMessage",{chatId:m.id,content:e.fileName,messageType:e.fileType.startsWith("image/")?"image":e.fileType.startsWith("video/")?"video":e.fileType.startsWith("audio/")?"audio":"file",fileUrl:e.fileUrl});return p(""),P([]),O.emit("stopTyping",{chatId:m.id}),void(J.current&&clearTimeout(J.current))}if(W){if(!W.id)return void c.error("No participantId found for pendingFriend! Check console for details.");try{const e=await Y({participantId:W.id});if(e.error)return void alert("Create chat failed: "+JSON.stringify(e.error));let a=null,i=null;if(e.data&&e.data.id)a=e.data.id,i=e.data;else if(e.data&&e.data._id)a=e.data._id,i=e.data;else{i=((await G()).data||[]).find(e=>e.participantId&&e.participantId.toString()===W.id.toString()),i&&(a=i.id)}a&&i?(u(i),z(null),O.emit("joinChat",a),setTimeout(()=>{f.trim()&&O.emit("sendMessage",{chatId:a,content:f.trim(),messageType:"text"});for(const e of s)O.emit("sendMessage",{chatId:a,content:e.fileName,messageType:e.fileType.startsWith("image/")?"image":e.fileType.startsWith("video/")?"video":e.fileType.startsWith("audio/")?"audio":"file",fileUrl:e.fileUrl});p(""),P([]),O.emit("stopTyping",{chatId:a}),J.current&&clearTimeout(J.current)},100)):z(null)}catch(e){c.error("Error creating chat and sending message:",e)}}}catch(e){console.error("Error sending message:",e),c.error("Error sending message: "+e.message)}finally{K(!1)}if(W){if(!W.id)return void c.error("No participantId found for pendingFriend! Check console for details.");try{const e=await Y({participantId:W.id});if(e.error)return void alert("Create chat failed: "+JSON.stringify(e.error));let s=null,a=null;if(e.data&&e.data.id)s=e.data.id,a=e.data;else if(e.data&&e.data._id)s=e.data._id,a=e.data;else{a=((await G()).data||[]).find(e=>e.participantId&&e.participantId.toString()===W.id.toString()),a&&(s=a.id)}s&&a?(u(a),z(null),O.emit("joinChat",s),setTimeout(()=>{O.emit("sendMessage",{chatId:s,content:f.trim(),messageType:"text"}),p(""),O.emit("stopTyping",{chatId:s}),J.current&&clearTimeout(J.current)},100)):z(null)}catch(e){c.error("Error creating chat and sending message:",e)}}}},te=async s=>{const a=Array.from(s.target.files);if(0===a.length)return;const i=a.filter(e=>!(e.size>10485760)||(c.error(`File ${e.name} is too large. Maximum size is 10MB.`),!1));if(0!==i.length){try{const s=await Promise.all(i.map(s=>(s=>new Promise(a=>{const i=new FileReader;i.onload=i=>{var t;a({id:Date.now()+Math.random(),file:s,preview:i.target.result,name:s.name,size:s.size,type:s.type,icon:(t=s.type,t.startsWith("image/")?e.jsx(y,{}):t.startsWith("video/")?e.jsx(g,{}):t.startsWith("audio/")?e.jsx(w,{}):e.jsx(S,{}))})},i.readAsDataURL(s)}))(s)));P(e=>[...e,...s]),c.success(`${i.length} file(s) attached successfully`)}catch(t){console.error("Error creating file previews:",t),c.error("Error attaching files")}s.target.value=""}},ne=e=>{P(s=>s.filter(s=>s.id!==e))},re=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ie())},le=e=>{p(e.target.value),O&&m&&(O.emit("typing",{chatId:m.id}),J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{O.emit("stopTyping",{chatId:m.id})},1e3))},de=()=>{u(null),U(new Set),R(!1),k(""),z(null),P([])},ce=e=>{u(e),U(new Set),R(!1),k(""),z(null),P([]),O&&(O.emit("joinChat",e.id),ee(e.id))},oe=async e=>{k(""),R(!1),z(e),P([]);const s=q.find(s=>s.participantId&&s.participantId.toString()===e.id.toString());if(s)return u(s),U(new Set),z(null),void(O&&(O.emit("joinChat",s.id),ee(s.id)));z(e)},he=e=>{const s=e.target.value;k(s),R(s.length>0)},me=()=>{E.length>0&&R(!0)},ue=()=>{setTimeout(()=>{R(!1)},200)},ge=V&&V.length>0,fe=m||W,pe=m||W,xe=(null==pe?void 0:pe.participantId)||(null==pe?void 0:pe.id),je=xe&&_.has(xe);return e.jsx(v,{children:e.jsx("div",{className:"message-container",children:x?fe?e.jsxs("div",{className:"chat-history",children:[e.jsx(I,{user:pe,isMobile:!0,onBack:de,online:je}),e.jsx(T,{messages:V,hasMessages:m&&ge,typingUsers:M,user:pe,messagesEndRef:$}),e.jsx(b,{messageInput:f,onInputChange:le,onKeyPress:re,onSend:ie,onAttach:te,attachedFiles:L,onRemoveFile:ne,isUploading:A,disabled:!(m||W)})]}):e.jsx(C,{chats:q,filteredFriends:ae,searchQuery:E,onSearchChange:he,onSearchFocus:me,onSearchBlur:ue,onFriendSelect:oe,onChatSelect:ce,selectedChat:m,showSearchResults:B,onlineUsers:_}):e.jsxs(e.Fragment,{children:[e.jsx(C,{chats:q,filteredFriends:ae,searchQuery:E,onSearchChange:he,onSearchFocus:me,onSearchBlur:ue,onFriendSelect:oe,onChatSelect:ce,selectedChat:m,showSearchResults:B,onlineUsers:_}),e.jsx("div",{className:"chat-history",children:fe?e.jsxs(e.Fragment,{children:[e.jsx(I,{user:pe,isMobile:!1,onBack:de,online:je}),e.jsx(T,{messages:V,hasMessages:m&&ge,typingUsers:M,user:pe,messagesEndRef:$}),e.jsx(b,{messageInput:f,onInputChange:le,onKeyPress:re,onSend:ie,onAttach:te,attachedFiles:L,onRemoveFile:ne,isUploading:A,disabled:!(m||W)})]}):e.jsx("div",{className:"no-chat-selected",children:e.jsxs("div",{className:"no-chat-content",children:[e.jsx("span",{children:e.jsx(N,{})}),e.jsx("h3",{children:"Select a conversation"}),e.jsx("p",{children:"Choose a chat from the list to start messaging"})]})})})]})})})};export{F as default};
//# sourceMappingURL=Message-BoI4FNrb.js.map
